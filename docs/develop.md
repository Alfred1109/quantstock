# 开发计划文档 (develop.md)

本文档概述了"基于大模型的金字塔交易法量化交易系统"项目从现有基础向 `docs/structure.md` 中定义的新架构进行重构的开发计划。

## 1. 引言

### 1.1 目的
此开发计划旨在指导项目重构过程，确保平稳过渡到新的模块化、可维护和可扩展的架构。重构的核心目标包括：
-   对齐 `docs/structure.md` 中定义的新文件和模块结构。
-   增强系统的模块化，实现关注点分离。
-   集成新的火山引擎DeepSeek大模型API。
-   提升代码质量、可测试性和可维护性。
-   遵循《Cursor 架构与开发规范》。

### 1.2 范围
重构范围包括现有代码库的核心功能，将其迁移到新架构的相应模块中。这涉及数据处理、LLM集成、策略逻辑、风险管理、订单执行、投资组合管理和回测等。

## 2. 重构阶段与任务

### 阶段 1: 核心基础设施搭建与配置管理迁移

**目标:** 建立新项目的骨架，实现标准化的配置管理。

*   **任务 1.1: 建立新目录结构**
    *   描述: 根据 `docs/structure.md` 创建所有顶层和 `src/` 内的模块目录。
    *   负责人: TBD
    *   预计工时: 0.5 天
*   **任务 1.2: 实施配置管理**
    *   描述:
        *   创建 `config/` 目录及初始配置文件 (`settings.yaml`, `llm_config.yaml`, `broker_config.yaml`)。
        *   `llm_config.yaml` 应包含DeepSeek模型的配置占位符 (API Key应通过环境变量或安全的 `.env` 文件管理，模型名称 `deepseek-v3-250324`，API文档URL作为参考)。
        *   创建 `.env.example` 并指导使用 `.env` 管理敏感信息 (如API Keys, 数据库凭证)。
    *   负责人: TBD
    *   预计工时: 1 天
*   **任务 1.3: 基础日志系统搭建**
    *   描述: 在 `src/monitoring_module/logger.py` 中实现基础的日志记录功能，支持不同级别和输出到文件/控制台。
    *   负责人: TBD
    *   预计工时: 0.5 天
*   **任务 1.4: 初始化依赖管理**
    *   描述: 创建/更新 `requirements.txt` (或 `pyproject.toml`)，包含项目初步的核心依赖。
    *   负责人: TBD
    *   预计工时: 0.5 天

### 阶段 2: 数据模块重构与数据提供商集成

**目标:** 将现有数据获取和处理逻辑迁移到新的数据模块，确保市场数据稳定接入。

*   **任务 2.1: 数据 Provider 实现**
    *   描述: 基于 `docs/structure.md` 中对 `src/data_module/providers/` 模块的规划，以及具体选择的数据提供商（例如 `tushare_provider.py`, `simulated_provider.py` 或自定义的 `base_provider.py` 的具体实现），迁移或重写数据接口的适配逻辑。确保能够稳定获取行情、财务等数据。
    *   负责人: TBD
    *   预计工时: 2-3 天
*   **任务 2.2: 定义数据Provider基类**
    *   描述: 创建 `src/data_module/providers/base_provider.py`，定义数据提供者的抽象接口。
    *   负责人: TBD
    *   预计工时: 0.5 天
*   **任务 2.3: 数据清洗与预处理桩实现**
    *   描述: 在 `src/data_module/cleaners/` 中创建数据清洗逻辑的初步实现或桩函数。
    *   负责人: TBD
    *   预计工时: 1 天
*   **任务 2.4: 特征工程桩实现**
    *   描述: 在 `src/data_module/feature_engineering/` 中为技术指标计算、LLM特征提取等创建初步实现或桩函数。
    *   负责人: TBD
    *   预计工时: 1 天
*   **任务 2.5: 数据存储接口设计与实现**
    *   描述: 设计并实现 `src/data_module/storage/` 中的时序数据库和元数据数据库的操作接口。初期可使用文件存储或轻量级数据库作为替代。
    *   负责人: TBD
    *   预计工时: 2 天

### 阶段 3: LLM模块实现 (DeepSeek集成)

**目标:** 实现与火山引擎DeepSeek大模型的对接，为策略层提供分析能力。

*   **任务 3.1: LLM Client 基类定义**
    *   描述: 创建 `src/llm_module/clients/base_llm_client.py` 定义LLM客户端的抽象接口。
    *   负责人: TBD
    *   预计工时: 0.5 天
*   **任务 3.2: DeepSeek Client 实现**
    *   描述:
        *   在 `src/llm_module/clients/deepseek_client.py` 中实现与火山引擎DeepSeek API的对接。
        *   API Key (`3470059d-f774-4302-81e0-50fa017fea38`) **严禁硬编码**，必须从配置 (`llm_config.yaml` 读取，最终通过 `.env` 或安全的环境变量注入) 获取。
        *   使用模型名称 `deepseek-v3-250324`。参考API文档 `https://console.volcengine.com/ark/region:ark+cn-beijing/endpoint/detail?Id=ep-m-20250331153858-fmfsr&Tab=api&Type=preset`。
    *   负责人: TBD
    *   预计工时: 2-3 天
*   **任务 3.3: Prompt工程初步开发**
    *   描述: 在 `src/llm_module/prompt_engineering/` 中设计并实现用于市场分析、信号生成的初步Prompt模板。
    *   负责人: TBD
    *   预计工时: 2 天
*   **任务 3.4: 信号解析器实现**
    *   描述: 在 `src/llm_module/signal_parsers.py` 中实现将LLM输出文本解析为结构化交易信号的逻辑。
    *   负责人: TBD
    *   预计工时: 1 天

### 阶段 4: 策略模块重构

**目标:** 将金字塔交易法与LLM信号结合，迁移到新的策略模块。

*   **任务 4.1: 策略基类定义**
    *   描述: 创建 `src/strategy_module/base_strategy.py` 定义交易策略的抽象接口。
    *   负责人: TBD
    *   预计工时: 0.5 天
*   **任务 4.2: 金字塔LLM策略实现**
    *   描述: 在 `src/strategy_module/pyramid_llm_strategy.py` 中迁移或重写金字塔交易法核心逻辑，并集成 `llm_module` 提供的信号。
    *   负责人: TBD
    *   预计工时: 3-4 天

### 阶段 5: 核心交易逻辑重构 (风险、执行、投资组合)

**目标:** 将分散的交易辅助功能整合到独立的模块中。

*   **任务 5.1: 风险管理模块迁移/实现**
    *   描述: 将现有风险控制逻辑（如仓位管理、止损止盈判断）迁移或重写到 `src/risk_module/` 下的相应文件 (`position_manager.py`, `order_validator.py`)。
    *   负责人: TBD
    *   预计工时: 2 天
*   **任务 5.2: 订单执行模块迁移/实现**
    *   描述:
        *   迁移或重写订单处理逻辑到 `src/execution_module/order_handler.py`。
        *   实现 `src/execution_module/brokers/base_broker.py` 和 `simulated_broker.py`。
        *   为对接真实券商API (如CTP) 预留接口。
    *   负责人: TBD
    *   预计工时: 2-3 天
*   **任务 5.3: 投资组合模块迁移/实现**
    *   描述: 将持仓跟踪、盈亏计算、绩效统计等功能迁移或重写到 `src/portfolio_module/` (`portfolio.py`, `performance.py`)。
    *   负责人: TBD
    *   预计工时: 2 天

### 阶段 6: 回测模块重构/实现

**目标:** 确保回测功能在新架构下能正常运行并生成报告。

*   **任务 6.1: 回测引擎迁移/实现**
    *   描述: 将现有回测引擎的核心逻辑迁移或重写到 `src/backtesting_module/engine.py`，使其能够加载新策略模块和数据模块。
    *   负责人: TBD
    *   预计工时: 3 天
*   **任务 6.2: 回测报告功能更新**
    *   描述: 更新 `src/backtesting_module/reporting.py` 以适应新数据结构并生成所需的回测报告。
    *   负责人: TBD
    *   预计工时: 1 天

### 阶段 7: 主应用逻辑与辅助工具迁移

**目标:** 整合所有模块，更新入口程序和辅助脚本。

*   **任务 7.1: `main.py` 重构**
    *   描述: 重构项目主入口 `main.py`，使其能够根据配置调用新架构下的各个模块来执行交易、回测等任务。
    *   负责人: TBD
    *   预计工时: 1-2 天
*   **任务 7.2: 工具函数迁移**
    *   描述: 将项目中通用的辅助函数整理并迁移到 `src/utils/` 目录下。
    *   负责人: TBD
    *   预计工时: 1 天
*   **任务 7.3: 辅助脚本更新/创建**
    *   描述: 更新或创建 `scripts/` 目录下的辅助脚本 (如 `run_backtest.py`, `download_historical_data.py`) 以适应新架构。
    *   负责人: TBD
    *   预计工时: 1 天

### 阶段 8: 测试、文档完善与代码审查

**目标:** 确保重构后系统的稳定性和质量，完善项目文档。

*   **任务 8.1: 单元测试编写**
    *   描述: 为各核心模块的关键功能编写单元测试，放入 `tests/unit/`。
    *   负责人: TBD
    *   预计工时: 持续进行，累计5-7 天
*   **任务 8.2: 集成测试编写**
    *   描述: 编写集成测试，覆盖主要业务流程（如数据获取->信号生成->策略执行->模拟成交），放入 `tests/integration/`。
    *   负责人: TBD
    *   预计工时: 3-4 天
*   **任务 8.3: 架构决策记录 (ADR) 更新**
    *   描述: 针对重构过程中的重要技术选型和决策，在 `docs/adr/` 目录下创建或更新ADR文档。例如，DeepSeek API集成决策。
    *   负责人: TBD
    *   预计工时: 1 天
*   **任务 8.4: `README.md` 更新**
    *   描述: 更新项目根目录的 `README.md`，包括新的安装指南、配置说明、启动命令等。
    *   负责人: TBD
    *   预计工时: 0.5 天
*   **任务 8.5: 算法文档化**
    *   描述: 在 `docs/algorithms/pyramid_llm_logic.md` 中详细记录金字塔与LLM结合的逻辑、LLM prompt设计思路等。
    *   负责人: TBD
    *   预计工时: 1 天
*   **任务 8.6: 代码审查**
    *   描述: 对重构后的代码进行全面的代码审查。
    *   负责人: 团队
    *   预计工时: 持续进行

## 3. 技术债务管理

在重构过程中，识别并记录遇到的技术债务。对于短期内无法彻底解决的技术债务，应在相关代码处添加明确注释（如 `TODO:`, `TECH_DEBT:`），并在项目管理工具中创建跟踪任务，计划在后续迭代中逐步偿还。每个迭代周期预留至少10-20%的时间用于处理技术债务和代码优化。

## 4. 风险评估与缓解策略

*   **风险1: 重构工作量预估不足。**
    *   缓解: 分阶段进行，每个阶段结束后重新评估后续阶段工作量。保持与团队的透明沟通。
*   **风险2: 现有功能在迁移过程中发生遗漏或行为变更。**
    *   缓解: 加强测试覆盖（单元测试、集成测试），迁移前后进行功能对比验证。
*   **风险3: DeepSeek API集成遇到未预料的技术难题。**
    *   缓解: 尽早进行API的PoC验证，熟悉其特性和限制。准备备选LLM方案或简化版信号生成逻辑。
*   **风险4: 数据迁移或兼容性问题。**
    *   缓解: 如果涉及历史数据格式变更，制定详细的数据迁移计划并进行测试。
*   **风险5: 团队成员对新架构理解不一致。**
    *   缓解: 定期组织架构和代码解读会议，确保团队理解一致。`docs/structure.md`作为核心参考。

## 5. 更新频率
本文档将在每个重构阶段开始前进行评审和更新，并在阶段完成后根据实际进展进行调整。 